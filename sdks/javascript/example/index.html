<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Page</title>
    <script src="../dist/index.iife.js"></script>
    <script src="./graph.js"></script>
    <script>
        let debugLink = null;
        let appRunId;
        let engineConnectionState = "disconnected";
        let handler = {
            onConnectionStateChange: (state) => {
                engineConnectionState = state;
                console.log("Engine connection state changed:", state);
                if (state === "connected") {
                    let linkContainer = document.getElementById("link-container");
                    if (debugLink) {
                        linkContainer.removeChild(debugLink);
                    }
                    debugLink = document.createElement("a");
                    debugLink.href = "http://localhost:3000/debug/" + appRunId;
                    debugLink.target = "_blank";
                    debugLink.textContent = "Debug Link";
                    linkContainer.appendChild(debugLink);

                    // Show publish buttons when connected
                    document.getElementById("webcam-button").style.display = "block";
                    document.getElementById("screenshare-button").style.display = "block";
                } else {
                    if (debugLink) {
                        let linkContainer = document.getElementById("link-container");
                        linkContainer.removeChild(debugLink);
                        debugLink = null;
                    }

                    // Hide publish buttons when disconnected
                    document.getElementById("webcam-button").style.display = "none";
                    document.getElementById("screenshare-button").style.display = "none";
                }
            }
        };
        const engine = new window.Gabber.Engine({ handler });

        async function connect() {
            let res = await fetch("http://localhost:8001/app/run", {
                method: "POST", body: JSON.stringify(GRAPH),
                headers: {
                    "Content-Type": "application/json"
                }
            });
            const respBody = await res.json();
            const connectionDetails = respBody.connection_details;
            appRunId = respBody.id;
            console.log("Response from debug_connection:", respBody);
            await engine.connect(connectionDetails);
            console.log("Connecting...", engine);
        }

        async function publishWebcam() {
            let webcamLocalTrack = await engine.getLocalTrack({ type: "webcam", width: 1280, height: 720 });
            webcamLocalTrack.attachToElement(document.getElementById("local_webcam"));
            await engine.publishToNode({
                localTrack: webcamLocalTrack,
                publishNodeId: "webcam_publish",
            });
            document.getElementById("webcam-sub-button").style.display = "block";
        }

        async function publishScreenshare() {
            let screenshareLocalTrack = await engine.getLocalTrack({ type: "screen_share", width: 1920, height: 1080 });
            screenshareLocalTrack.attachToElement(document.getElementById("local_screenshare"));
            await engine.publishToNode({
                localTrack: screenshareLocalTrack,
                publishNodeId: "screen_publish",
            });
            document.getElementById("screenshare-sub-button").style.display = "block";
        }

        async function subscribeWebcam() {
            const subscription = await engine.subscribeToNode({ outputNodeId: "output_webcam" });
            const remoteTrack = await subscription.waitForVideoTrack();
            remoteTrack.attachToElement(document.getElementById("remote_webcam"));
        }

        async function subscribeScreenshare() {
            const subscription = await engine.subscribeToNode({ outputNodeId: "output_screen" });
            const remoteTrack = await subscription.waitForVideoTrack();
            remoteTrack.attachToElement(document.getElementById("remote_screenshare"));
        }

    </script>
</head>

<body>
    <h1>Basic Javascript SDK Example</h1>

    <div style="display: flex; flex-direction: row; align-items: center;">
        <div>
            <video id="local_webcam" width="320" height="240" controls>
            </video>
            <button id="webcam-button" onclick="publishWebcam()" style="display: none;">Publish Webcam</button>
        </div>
        <div> ==> </div>
        <div>
            <video id="remote_webcam" width="320" height="240" controls>
            </video>
            <button id="webcam-sub-button" onclick="subscribeWebcam()" style="display: none;">
                Subscribe Webcam</button>

        </div>
    </div>


    <div style="display: flex; flex-direction: row; align-items: center;">
        <div>
            <video id="local_screenshare" width="320" height="240" controls>
            </video>
            <button id="screenshare-button" onclick="publishScreenshare()" style="display: none;">Publish
                Screenshare</button>
        </div>
        <div> ==> </div>
        <div>
            <video id="remote_screenshare" width="320" height="240" controls>
            </video>
            <button id="screenshare-sub-button" onclick="subscribeScreenshare()" style="display: none;">
                Subscribe Screenshare</button>
        </div>

    </div>

    <!-- Button -->
    <div id="button-container">
        <button id="connect-button" onclick="connect()">Connect</button>
    </div>

    <div id="link-container">
    </div>

</body>

</html>